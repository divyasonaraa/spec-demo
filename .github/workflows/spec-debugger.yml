name: Spec Debugger

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  run-debugger:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm ci

      - name: Sync TypeScript samples to JSON
        id: sync_validate
        run: |
          echo "ðŸ”„ Syncing TypeScript samples to JSON..."
          # Just sync, don't validate yet (validation happens in next step)
          node tools/sync-and-validate-simple.mjs || echo "âš ï¸ Sync had issues, will use existing JSONs"
        continue-on-error: true

      - name: Discover all form configs
        id: discover
        run: |
          # Find all JSON files in public/examples/ (excluding debugger-results)
          CONFIGS=$(find public/examples -name "*.json" -type f ! -name "debugger-results.json" 2>/dev/null || true)
          
          if [ -z "$CONFIGS" ]; then
            echo "âš ï¸ No configs found in public/examples/"
            echo "configs=" >> $GITHUB_OUTPUT
          else
            echo "âœ… Found $(echo "$CONFIGS" | wc -l) config(s)"
            echo "$CONFIGS" | while read config; do
              echo "   - $(basename $config)"
            done
            echo "configs<<EOF" >> $GITHUB_OUTPUT
            echo "$CONFIGS" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          fi

      - name: Run Debugger on all configs
        id: run_all
        run: |
          mkdir -p ci-results
          EXIT_CODE=0
          CONFIGS="${{ steps.discover.outputs.configs }}"
          
          if [ -z "$CONFIGS" ]; then
            echo "No configs to analyze"
            exit 0
          fi
          
          # Process each config and track failures
          while IFS= read -r config; do
            if [ -n "$config" ]; then
              echo "============================================"
              echo "Analyzing: $config"
              echo "============================================"
              BASENAME=$(basename "$config" .json)
              OUTPUT="ci-results/${BASENAME}-results.json"
              
              if node tools/debugger/cli/run-debugger.mjs "$config" tools/debugger/specs/invariants.json tools/debugger/specs/examples.json > "ci-results/${BASENAME}.log" 2>&1; then
                echo "âœ“ $BASENAME: PASSED (no errors)" >> ci-results/summary.txt
              else
                echo "âœ— $BASENAME: FAILED (errors detected)" >> ci-results/summary.txt
                EXIT_CODE=1
              fi
              
              # Copy results with unique name
              if [ -f "$(dirname "$config")/debugger-results.json" ]; then
                cp "$(dirname "$config")/debugger-results.json" "$OUTPUT"
              fi
            fi
          done <<< "$CONFIGS"
          
          # Report overall status
          if [ $EXIT_CODE -eq 1 ]; then
            echo "âŒ One or more configs failed with errors"
            exit 1
          else
            echo "âœ… All configs passed (no errors detected)"
            exit 0
          fi

      - name: Upload findings artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: debugger-results
          path: |
            ci-results/*.json
            ci-results/*.log
            ci-results/summary.txt
          if-no-files-found: ignore

      - name: Generate formatted summary with detailed findings
        if: always()
        run: |
          echo "## ðŸ” Spec Debugger Summary" > summary.md
          echo "" >> summary.md
          echo "| Config | Errors | Warnings | Info | Status |" >> summary.md
          echo "|--------|--------|----------|------|--------|" >> summary.md
          
          HAS_ERRORS=false
          HAS_WARNINGS=false
          HAS_INFO=false
          
          # Parse results from each config
          for result in ci-results/*-results.json; do
            if [ -f "$result" ]; then
              BASENAME=$(basename "$result" -results.json)
              ERRORS=$(jq '[.[] | select(.severity=="error")] | length' "$result" 2>/dev/null || echo "0")
              WARNINGS=$(jq '[.[] | select(.severity=="warning")] | length' "$result" 2>/dev/null || echo "0")
              INFO=$(jq '[.[] | select(.severity=="info")] | length' "$result" 2>/dev/null || echo "0")
              
              if [ "$ERRORS" -gt 0 ]; then
                STATUS="âŒ Failed"
                HAS_ERRORS=true
              elif [ "$WARNINGS" -gt 0 ]; then
                STATUS="âš ï¸  Warnings"
                HAS_WARNINGS=true
              else
                STATUS="âœ… Passed"
              fi
              
              [ "$INFO" -gt 0 ] && HAS_INFO=true
              
              echo "| \`$BASENAME\` | $ERRORS | $WARNINGS | $INFO | $STATUS |" >> summary.md
            fi
          done
          
          # If no results found, show message
          if ! ls ci-results/*-results.json 1> /dev/null 2>&1; then
            echo "| *(no configs found)* | - | - | - | - |" >> summary.md
          fi
          
          echo "" >> summary.md
          
          # Show detailed findings for errors
          if [ "$HAS_ERRORS" = true ]; then
            echo "---" >> summary.md
            echo "" >> summary.md
            echo "## âŒ Errors Found (Must Fix)" >> summary.md
            echo "" >> summary.md
            
            for result in ci-results/*-results.json; do
              if [ -f "$result" ]; then
                BASENAME=$(basename "$result" -results.json)
                ERROR_COUNT=$(jq '[.[] | select(.severity=="error")] | length' "$result" 2>/dev/null || echo "0")
                
                if [ "$ERROR_COUNT" -gt 0 ]; then
                  echo "### ðŸ“„ \`$BASENAME.json\`" >> summary.md
                  echo "" >> summary.md
                  
                  # Extract each error with details
                  jq -r '.[] | select(.severity=="error") | 
                    "**" + .title + "**\n\n" +
                    "**Reason:** " + .explanation + "\n\n" +
                    "**Location:** `" + (.jsonPaths | join(", ")) + "`\n\n" +
                    "**Fix:**\n" + 
                    (.fixGuidance | to_entries | map("  " + ((.key | tonumber) + 1 | tostring) + ". " + .value) | join("\n")) + 
                    "\n\n---\n"' "$result" >> summary.md
                fi
              fi
            done
          fi
          
          # Show detailed findings for warnings
          if [ "$HAS_WARNINGS" = true ]; then
            echo "" >> summary.md
            echo "## âš ï¸  Warnings (Should Review)" >> summary.md
            echo "" >> summary.md
            
            for result in ci-results/*-results.json; do
              if [ -f "$result" ]; then
                BASENAME=$(basename "$result" -results.json)
                WARNING_COUNT=$(jq '[.[] | select(.severity=="warning")] | length' "$result" 2>/dev/null || echo "0")
                
                if [ "$WARNING_COUNT" -gt 0 ]; then
                  echo "### ðŸ“„ \`$BASENAME.json\`" >> summary.md
                  echo "" >> summary.md
                  
                  jq -r '.[] | select(.severity=="warning") | 
                    "**" + .title + "**\n\n" +
                    "**Reason:** " + .explanation + "\n\n" +
                    "**Location:** `" + (.jsonPaths | join(", ")) + "`\n\n" +
                    "**Fix:**\n" + 
                    (.fixGuidance | to_entries | map("  " + ((.key | tonumber) + 1 | tostring) + ". " + .value) | join("\n")) + 
                    "\n\n---\n"' "$result" >> summary.md
                fi
              fi
            done
          fi
          
          # Show detailed findings for info
          if [ "$HAS_INFO" = true ]; then
            echo "" >> summary.md
            echo "<details>" >> summary.md
            echo "<summary>ðŸ’¡ Info & Suggestions (Optional Improvements)</summary>" >> summary.md
            echo "" >> summary.md
            
            for result in ci-results/*-results.json; do
              if [ -f "$result" ]; then
                BASENAME=$(basename "$result" -results.json)
                INFO_COUNT=$(jq '[.[] | select(.severity=="info")] | length' "$result" 2>/dev/null || echo "0")
                
                if [ "$INFO_COUNT" -gt 0 ]; then
                  echo "### ðŸ“„ \`$BASENAME.json\`" >> summary.md
                  echo "" >> summary.md
                  
                  jq -r '.[] | select(.severity=="info") | 
                    "**" + .title + "**\n\n" +
                    "**Reason:** " + .explanation + "\n\n" +
                    "**Location:** `" + (.jsonPaths | join(", ")) + "`\n\n" +
                    "**Suggestions:**\n" + 
                    (.fixGuidance | to_entries | map("  " + ((.key | tonumber) + 1 | tostring) + ". " + .value) | join("\n")) + 
                    "\n\n---\n"' "$result" >> summary.md
                fi
              fi
            done
            
            echo "</details>" >> summary.md
          fi
          
          echo "" >> summary.md
          echo "---" >> summary.md
          echo "" >> summary.md
          echo "ðŸ“¦ **Download artifacts** for full JSON reports with reproducers" >> summary.md
        shell: bash

      - name: Comment summary
        if: always()
        uses: peter-evans/create-or-update-comment@v4
        with:
          issue-number: ${{ github.event.pull_request.number }}
          body-path: summary.md
