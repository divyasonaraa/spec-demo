name: Spec Debugger

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  run-debugger:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm ci

      - name: Discover TS sample configs
        id: discover
        run: |
          # Find all TypeScript sample files in src/config/samples/
          SAMPLES=$(find src/config/samples -name "*.ts" -type f 2>/dev/null || true)
          if [ -z "$SAMPLES" ]; then
            echo "âš ï¸ No TypeScript samples found in src/config/samples/"
            echo "samples=" >> $GITHUB_OUTPUT
          else
            echo "âœ… Found $(echo "$SAMPLES" | wc -l) sample(s)"
            echo "$SAMPLES" | while read f; do
              echo "   - $(basename $f)"
            done
            echo "samples<<EOF" >> $GITHUB_OUTPUT
            echo "$SAMPLES" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          fi

      - name: Run Debugger on TS samples
        id: run_all
        run: |
          mkdir -p ci-results
          EXIT_CODE=0
          SAMPLES="${{ steps.discover.outputs.samples }}"
          
          if [ -z "$SAMPLES" ]; then
            echo "No samples to analyze"
            exit 0
          fi
          
          # Process each config and track failures
          # Ensure summary file exists
          : > ci-results/summary.txt
          printf '%s\n' "$SAMPLES" | while IFS= read -r sample; do
            if [ -n "$sample" ]; then
              echo "============================================"
              echo "Analyzing TS sample: $sample"
              echo "============================================"
              BASENAME=$(basename "$sample" .ts)
              LOGFILE="ci-results/${BASENAME}.log"
              
              # Run TS-aware debugger CLI, capture output only (no JSON sync)
              if node tools/debugger/cli/run-debugger-config.mjs "$sample" > "$LOGFILE" 2>&1; then
                echo "âœ“ $BASENAME: PASSED (no errors)" >> ci-results/summary.txt
              else
                echo "âœ— $BASENAME: FAILED (errors detected)" >> ci-results/summary.txt
                EXIT_CODE=1
              fi
            fi
          done
          
          # Report overall status
          if [ $EXIT_CODE -eq 1 ]; then
            echo "âŒ One or more configs failed with errors"
            exit 1
          else
            echo "âœ… All configs passed (no errors detected)"
            exit 0
          fi

      - name: Upload artifacts (logs only)
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: debugger-logs
          path: |
            ci-results/*.log
            ci-results/summary.txt
          if-no-files-found: ignore

      - name: Generate summary (from logs)
        if: always()
        run: |
          echo "## ðŸ” Spec Debugger Summary" > summary.md
          echo "" >> summary.md
          echo "Logs and status for TypeScript samples:" >> summary.md
          echo "" >> summary.md
          if [ -f ci-results/summary.txt ]; then
            echo '```text' >> summary.md
            cat ci-results/summary.txt >> summary.md
            echo '```' >> summary.md
          else
            echo "(no samples analyzed)" >> summary.md
          fi
        shell: bash

      - name: Comment summary
        if: always()
        uses: peter-evans/create-or-update-comment@v4
        with:
          issue-number: ${{ github.event.pull_request.number }}
          body-path: summary.md
