name: Spec Debugger

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  run-debugger:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Discover all form configs
        id: discover
        run: |
          # Find all JSON files in public/examples/
          CONFIGS=$(find public/examples -name "*.json" -type f | grep -v "debugger-results" || true)
          if [ -z "$CONFIGS" ]; then
            echo "No configs found"
            echo "configs=" >> $GITHUB_OUTPUT
          else
            echo "Found configs: $CONFIGS"
            echo "configs<<EOF" >> $GITHUB_OUTPUT
            echo "$CONFIGS" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          fi

      - name: Run Debugger on all configs
        id: run_all
        continue-on-error: true
        run: |
          mkdir -p ci-results
          EXIT_CODE=0
          CONFIGS="${{ steps.discover.outputs.configs }}"
          
          if [ -z "$CONFIGS" ]; then
            echo "No configs to analyze"
            exit 0
          fi
          
          echo "$CONFIGS" | while IFS= read -r config; do
            if [ -n "$config" ]; then
              echo "============================================"
              echo "Analyzing: $config"
              echo "============================================"
              BASENAME=$(basename "$config" .json)
              OUTPUT="ci-results/${BASENAME}-results.json"
              
              if node tools/debugger/cli/run-debugger.mjs "$config" tools/debugger/specs/invariants.json tools/debugger/specs/examples.json > "ci-results/${BASENAME}.log" 2>&1; then
                echo "âœ“ $BASENAME: PASSED (no errors)" >> ci-results/summary.txt
              else
                echo "âœ— $BASENAME: FAILED (errors detected)" >> ci-results/summary.txt
                EXIT_CODE=1
              fi
              
              # Copy results with unique name
              if [ -f "$(dirname "$config")/debugger-results.json" ]; then
                cp "$(dirname "$config")/debugger-results.json" "$OUTPUT"
              fi
            fi
          done
          
          exit $EXIT_CODE

      - name: Upload findings artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: debugger-results
          path: |
            ci-results/*.json
            ci-results/*.log
            ci-results/summary.txt
          if-no-files-found: ignore

      - name: Generate formatted summary table
        if: always()
        run: |
          echo "## ðŸ” Spec Debugger Summary" > summary.md
          echo "" >> summary.md
          echo "Analyzed form configurations for common bug patterns:" >> summary.md
          echo "" >> summary.md
          echo "| Config | Errors | Warnings | Info | Status |" >> summary.md
          echo "|--------|--------|----------|------|--------|" >> summary.md
          
          # Parse results from each config
          for result in ci-results/*-results.json; do
            if [ -f "$result" ]; then
              BASENAME=$(basename "$result" -results.json)
              ERRORS=$(jq '[.[] | select(.severity=="error")] | length' "$result" 2>/dev/null || echo "0")
              WARNINGS=$(jq '[.[] | select(.severity=="warning")] | length' "$result" 2>/dev/null || echo "0")
              INFO=$(jq '[.[] | select(.severity=="info")] | length' "$result" 2>/dev/null || echo "0")
              
              if [ "$ERRORS" -gt 0 ]; then
                STATUS="âŒ Failed"
              elif [ "$WARNINGS" -gt 0 ]; then
                STATUS="âš ï¸  Warnings"
              else
                STATUS="âœ… Passed"
              fi
              
              echo "| $BASENAME | $ERRORS | $WARNINGS | $INFO | $STATUS |" >> summary.md
            fi
          done
          
          # If no results found, show message
          if [ ! -f ci-results/*-results.json ]; then
            echo "| *(no configs found)* | - | - | - | - |" >> summary.md
          fi
          
          echo "" >> summary.md
          echo "### ðŸ“Š Analysis Details" >> summary.md
          echo "" >> summary.md
          echo "**Bug Classes Detected:**" >> summary.md
          echo "- ðŸš« Required fields hidden by conditional visibility" >> summary.md
          echo "- âš–ï¸ Mutually exclusive conditions active together" >> summary.md
          echo "- ðŸ”— Impossible value combinations across fields" >> summary.md
          echo "- ðŸ“‹ Payload schema drift (type/required mismatches)" >> summary.md
          echo "- ðŸ”„ Breaking changes between config versions" >> summary.md
          echo "" >> summary.md
          echo "**Legend:**" >> summary.md
          echo "- âœ… **Passed**: No errors detected (warnings/info OK)" >> summary.md
          echo "- âš ï¸ **Warnings**: Non-blocking issues found" >> summary.md
          echo "- âŒ **Failed**: Blocking errors that need fixes" >> summary.md
          echo "" >> summary.md
          echo "ðŸ“¦ **Download artifacts:** Full reports with JSON paths, reproducer states, and fix guidance" >> summary.md
          echo "" >> summary.md
          echo "ðŸ’¡ **Review logs:** Check job output for detailed step-by-step analysis" >> summary.md
        shell: bash

      - name: Comment summary
        if: always()
        uses: peter-evans/create-or-update-comment@v4
        with:
          issue-number: ${{ github.event.pull_request.number }}
          body-path: summary.md
