name: Auto-Fix GitHub Issues

on:
  issues:
    types: [labeled]  # Only trigger on label events, not on issue creation
  workflow_dispatch:
    inputs:
      issue_number:
        description: 'Issue number to process'
        required: true
        type: number

permissions:
  issues: write
  contents: write
  pull-requests: write
  models: read

jobs:
  check-prerequisites:
    name: Check Prerequisites
    runs-on: ubuntu-latest
    timeout-minutes: 1
    outputs:
      should_proceed: ${{ steps.check.outputs.should_proceed }}
      skip_reason: ${{ steps.check.outputs.skip_reason }}
    
    steps:
      - name: Check if auto-fix should proceed
        id: check
        run: |
          # Get all issue labels
          LABELS='${{ toJSON(github.event.issue.labels.*.name) }}'
          echo "Issue labels: $LABELS"
          
          # Check for required labels: must have BOTH (bug OR feature) AND (auto-fix OR auto-fix-approved)
          HAS_BUG=$(echo "$LABELS" | jq -e '.[] | select(. == "bug")' > /dev/null 2>&1 && echo "true" || echo "false")
          HAS_FEATURE=$(echo "$LABELS" | jq -e '.[] | select(. == "feature")' > /dev/null 2>&1 && echo "true" || echo "false")
          HAS_AUTO_FIX=$(echo "$LABELS" | jq -e '.[] | select(. == "auto-fix" or . == "auto-fix-approved")' > /dev/null 2>&1 && echo "true" || echo "false")
          
          echo "Has bug label: $HAS_BUG"
          echo "Has feature label: $HAS_FEATURE"
          echo "Has auto-fix label: $HAS_AUTO_FIX"
          
          # For labeled event, only proceed if the new label is auto-fix or auto-fix-approved
          if [ "${{ github.event.action }}" = "labeled" ]; then
            LABEL_NAME="${{ github.event.label.name }}"
            echo "Label added: $LABEL_NAME"
            
            # Only trigger when auto-fix label is added (not other labels)
            if [ "$LABEL_NAME" != "auto-fix" ] && [ "$LABEL_NAME" != "auto-fix-approved" ]; then
              echo "should_proceed=false" >> $GITHUB_OUTPUT
              echo "skip_reason=Ignoring non-auto-fix label: $LABEL_NAME" >> $GITHUB_OUTPUT
              echo "⊘ Skipping: Not an auto-fix label"
              exit 0
            fi
            
            # Must also have bug or feature label
            if [ "$HAS_BUG" = "false" ] && [ "$HAS_FEATURE" = "false" ]; then
              echo "should_proceed=false" >> $GITHUB_OUTPUT
              echo "skip_reason=Missing required label: issue must have 'bug' or 'feature' label along with 'auto-fix'" >> $GITHUB_OUTPUT
              echo "⊘ Skipping: Missing bug/feature label"
              exit 0
            fi
            
            echo "should_proceed=true" >> $GITHUB_OUTPUT
            echo "✓ Auto-fix triggered: has auto-fix label AND bug/feature label"
          else
            # For workflow_dispatch, check both conditions
            if [ "$HAS_AUTO_FIX" = "false" ]; then
              echo "should_proceed=false" >> $GITHUB_OUTPUT
              echo "skip_reason=No auto-fix label (add 'auto-fix' or 'auto-fix-approved' label to trigger)" >> $GITHUB_OUTPUT
              echo "⊘ Skipping: No auto-fix approval label"
              exit 0
            fi
            
            if [ "$HAS_BUG" = "false" ] && [ "$HAS_FEATURE" = "false" ]; then
              echo "should_proceed=false" >> $GITHUB_OUTPUT
              echo "skip_reason=Missing required label: issue must have 'bug' or 'feature' label" >> $GITHUB_OUTPUT
              echo "⊘ Skipping: Missing bug/feature label"
              exit 0
            fi
            
            echo "should_proceed=true" >> $GITHUB_OUTPUT
            echo "✓ Issue has required labels"
          fi

  triage:
    name: Triage Issue
    runs-on: ubuntu-latest
    needs: check-prerequisites
    if: needs.check-prerequisites.outputs.should_proceed == 'true'
    timeout-minutes: 1
    outputs:
      triage_result: ${{ steps.triage.outputs.result }}
      auto_fix_decision: ${{ steps.triage.outputs.decision }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install dependencies
        run: |
          cd .github/agents
          npm install
      
      - name: Run triage agent
        id: triage
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY_OWNER: ${{ github.repository_owner }}
          GITHUB_REPOSITORY_NAME: ${{ github.event.repository.name }}
          ISSUE_NUMBER: ${{ github.event.issue.number || inputs.issue_number }}
        run: |
          cd .github/agents
          RESULT=$(node triage-agent.js)
          echo "$RESULT"
          
          # Extract decision for workflow routing (result is wrapped in {success, data})
          DECISION=$(echo "$RESULT" | jq -r '.data.autoFixDecision // "HUMAN_REVIEW_REQUIRED"')
          echo "decision=$DECISION" >> $GITHUB_OUTPUT
          
          # Store full result
          echo "result<<EOF" >> $GITHUB_OUTPUT
          echo "$RESULT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
      
      - name: Upload triage result
        uses: actions/upload-artifact@v4
        with:
          name: triage-result
          path: |
            .github/agents/triage-result.json
          retention-days: 7
        continue-on-error: true

  auto-fix:
    name: Generate & Apply Fix
    runs-on: ubuntu-latest
    needs: triage
    if: needs.triage.outputs.auto_fix_decision == 'AUTO_FIX' || needs.triage.outputs.auto_fix_decision == 'DRAFT_PR'
    timeout-minutes: 3
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for git operations
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
      
      - name: Install dependencies
        run: |
          cd .github/agents
          npm install
      
      - name: Download triage result
        uses: actions/download-artifact@v4
        with:
          name: triage-result
          path: .github/agents/
      
      - name: Run auto-fix agent
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          ISSUE_NUMBER: ${{ github.event.issue.number || inputs.issue_number }}
          TRIAGE_RESULT_PATH: ./triage-result.json
          OUTPUT_PATH: ./commit-result.json
          DEFAULT_BRANCH: ${{ github.event.repository.default_branch || 'main' }}
        run: |
          cd .github/agents
          node auto-fix-agent.js
      
      - name: Upload commit result
        uses: actions/upload-artifact@v4
        with:
          name: commit-result
          path: .github/agents/commit-result.json
          retention-days: 7
        continue-on-error: true
  
  pr:
    name: Create Pull Request
    runs-on: ubuntu-latest
    needs: [triage, auto-fix]
    if: |
      (needs.triage.outputs.auto_fix_decision == 'AUTO_FIX' || needs.triage.outputs.auto_fix_decision == 'DRAFT_PR') &&
      needs.auto-fix.result == 'success'
    timeout-minutes: 1
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install dependencies
        run: |
          cd .github/agents
          npm install
      
      - name: Download triage result
        uses: actions/download-artifact@v4
        with:
          name: triage-result
          path: .github/agents/
      
      - name: Download commit result
        uses: actions/download-artifact@v4
        with:
          name: commit-result
          path: .github/agents/
      
      - name: Run PR generator
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          ISSUE_NUMBER: ${{ github.event.issue.number || inputs.issue_number }}
          TRIAGE_RESULT_PATH: ./triage-result.json
          COMMIT_RESULT_PATH: ./commit-result.json
          OUTPUT_PATH: ./pr-result.json
          DEFAULT_BRANCH: ${{ github.event.repository.default_branch || 'main' }}
        run: |
          cd .github/agents
          node pr-generator.js
      
      - name: Upload PR result
        uses: actions/upload-artifact@v4
        with:
          name: pr-result
          path: .github/agents/pr-result.json
          retention-days: 7
