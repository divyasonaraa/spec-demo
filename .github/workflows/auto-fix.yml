name: Auto-Fix GitHub Issues

on:
  issues:
    types: [opened]
  workflow_dispatch:
    inputs:
      issue_number:
        description: 'Issue number to process'
        required: true
        type: number

permissions:
  issues: write
  contents: write
  pull-requests: write
  models: read

jobs:
  triage:
    name: Triage Issue
    runs-on: ubuntu-latest
    timeout-minutes: 1
    outputs:
      triage_result: ${{ steps.triage.outputs.result }}
      auto_fix_decision: ${{ steps.triage.outputs.decision }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install dependencies
        run: |
          cd .github/agents
          npm install
      
      - name: Run triage agent
        id: triage
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY_OWNER: ${{ github.repository_owner }}
          GITHUB_REPOSITORY_NAME: ${{ github.event.repository.name }}
          ISSUE_NUMBER: ${{ github.event.issue.number || inputs.issue_number }}
        run: |
          cd .github/agents
          RESULT=$(node triage-agent.js)
          echo "$RESULT"
          
          # Extract decision for workflow routing (result is wrapped in {success, data})
          DECISION=$(echo "$RESULT" | jq -r '.data.autoFixDecision // "HUMAN_REVIEW_REQUIRED"')
          echo "decision=$DECISION" >> $GITHUB_OUTPUT
          
          # Store full result
          echo "result<<EOF" >> $GITHUB_OUTPUT
          echo "$RESULT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
      
      - name: Upload triage result
        uses: actions/upload-artifact@v4
        with:
          name: triage-result
          path: |
            .github/agents/triage-result.json
          retention-days: 7
        continue-on-error: true

  planner:
    name: Generate Fix Plan
    runs-on: ubuntu-latest
    needs: triage
    if: needs.triage.outputs.auto_fix_decision == 'AUTO_FIX' || needs.triage.outputs.auto_fix_decision == 'DRAFT_PR'
    timeout-minutes: 2
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install dependencies
        run: |
          cd .github/agents
          npm install
      
      - name: Download triage result
        uses: actions/download-artifact@v4
        with:
          name: triage-result
          path: .github/agents/
      
      - name: Run planner agent
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          ISSUE_NUMBER: ${{ github.event.issue.number || inputs.issue_number }}
          TRIAGE_RESULT_PATH: ./triage-result.json
          OUTPUT_PATH: ./fix-plan.json
        run: |
          cd .github/agents
          node planner-agent.js
      
      - name: Upload fix plan
        uses: actions/upload-artifact@v4
        with:
          name: fix-plan
          path: .github/agents/fix-plan.json
          retention-days: 7
        continue-on-error: true
  
  code:
    name: Generate Code Fix
    runs-on: ubuntu-latest
    needs: [triage, planner]
    if: |
      (needs.triage.outputs.auto_fix_decision == 'AUTO_FIX' || needs.triage.outputs.auto_fix_decision == 'DRAFT_PR') &&
      needs.planner.result == 'success'
    timeout-minutes: 5
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for git operations
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
      
      - name: Install dependencies
        run: |
          cd .github/agents
          npm install
      
      - name: Download triage result
        uses: actions/download-artifact@v4
        with:
          name: triage-result
          path: .github/agents/
      
      - name: Download fix plan
        uses: actions/download-artifact@v4
        with:
          name: fix-plan
          path: .github/agents/
      
      - name: Run code agent
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          ISSUE_NUMBER: ${{ github.event.issue.number || inputs.issue_number }}
          FIX_PLAN_PATH: ./fix-plan.json
          OUTPUT_PATH: ./commit-result.json
          DEFAULT_BRANCH: ${{ github.event.repository.default_branch || 'main' }}
        run: |
          cd .github/agents
          node code-agent.js
      
      - name: Upload commit result
        uses: actions/upload-artifact@v4
        with:
          name: commit-result
          path: .github/agents/commit-result.json
          retention-days: 7
  
  pr:
    name: Create Pull Request
    runs-on: ubuntu-latest
    needs: [triage, planner, code]
    if: |
      (needs.triage.outputs.auto_fix_decision == 'AUTO_FIX' || needs.triage.outputs.auto_fix_decision == 'DRAFT_PR') &&
      needs.planner.result == 'success' &&
      needs.code.result == 'success'
    timeout-minutes: 1
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install dependencies
        run: |
          cd .github/agents
          npm install
      
      - name: Download triage result
        uses: actions/download-artifact@v4
        with:
          name: triage-result
          path: .github/agents/
      
      - name: Download fix plan
        uses: actions/download-artifact@v4
        with:
          name: fix-plan
          path: .github/agents/
      
      - name: Download commit result
        uses: actions/download-artifact@v4
        with:
          name: commit-result
          path: .github/agents/
      
      - name: Run PR generator
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          ISSUE_NUMBER: ${{ github.event.issue.number || inputs.issue_number }}
          TRIAGE_RESULT_PATH: ./triage-result.json
          FIX_PLAN_PATH: ./fix-plan.json
          COMMIT_RESULT_PATH: ./commit-result.json
          OUTPUT_PATH: ./pr-result.json
          DEFAULT_BRANCH: ${{ github.event.repository.default_branch || 'main' }}
        run: |
          cd .github/agents
          node pr-generator.js
      
      - name: Upload PR result
        uses: actions/upload-artifact@v4
        with:
          name: pr-result
          path: .github/agents/pr-result.json
          retention-days: 7
