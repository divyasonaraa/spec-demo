# Data Model: Automated GitHub Issue Triage and Auto-Fix System

**Feature**: [spec.md](./spec.md)  
**Created**: 2025-12-02  
**Phase**: 1 - Design

## Overview

This document defines the data structures and their relationships for the automated GitHub issue processing system. All entities are designed to be serializable to JSON for API communication between agents and persistent storage in GitHub issue comments/PR descriptions.

## Core Entities

### Issue

Represents a GitHub issue to be processed.

**Source**: GitHub Webhook Payload (`issues.opened` event)

**Structure**:
```typescript
interface Issue {
  number: number;                    // GitHub issue number (unique per repo)
  title: string;                     // Issue title
  body: string;                      // Issue description (markdown)
  labels: Label[];                   // Applied labels
  author: User;                      // Issue creator
  created_at: string;                // ISO 8601 timestamp
  url: string;                       // GitHub issue URL
  repository: Repository;            // Parent repository info
}

interface Label {
  name: string;                      // Label name (e.g., "bug", "auto-triage")
  color: string;                     // Hex color code
}

interface User {
  login: string;                     // GitHub username
  type: 'User' | 'Bot';             // Account type
}

interface Repository {
  owner: string;                     // Repository owner (org or user)
  name: string;                      // Repository name
  default_branch: string;            // Usually "main" or "master"
}
```

**Validation Rules**:
- `number` must be positive integer
- `title` must not be empty (GitHub enforces this)
- `body` may be empty (freeform issues allowed)
- `created_at` must be valid ISO 8601 timestamp
- `author.login` ending with `[bot]` indicates bot-created issue

**Relationships**:
- Issue → TriageResult (1:1) - Each issue produces one triage analysis
- Issue → FixPlan (1:0..1) - LOW/MEDIUM risk issues may produce a fix plan
- Issue → PullRequest (1:0..1) - Successful fixes result in one PR

---

### TriageResult

Classification and analysis output from the triage agent.

**Source**: Triage Agent (LLM or keyword heuristics)

**Structure**:
```typescript
interface TriageResult {
  issue_number: number;              // Reference to source issue
  classification: IssueType;         // Issue category
  risk: RiskLevel;                   // Risk assessment
  affected_files: string[];          // Likely files to change (paths from repo root)
  skillset: string[];                // Required expertise (e.g., ["frontend", "vue"])
  auto_fix_decision: AutoFixDecision; // Whether to attempt auto-fix
  reasoning: string;                 // Human-readable explanation
  security_flags: SecurityFlag[];    // Security concerns detected
  estimated_complexity: Complexity;  // Effort estimate
  suggested_labels: string[];        // Recommended GitHub labels
  timestamp: string;                 // ISO 8601 when triage completed
}

type IssueType = 'BUG' | 'FEATURE' | 'DOCS' | 'CHORE' | 'OTHER';

type RiskLevel = 'LOW' | 'MEDIUM' | 'HIGH';

type AutoFixDecision = 'YES' | 'HUMAN_REVIEW_REQUIRED';

type Complexity = 'TRIVIAL' | 'SIMPLE' | 'MODERATE' | 'COMPLEX';

interface SecurityFlag {
  type: 'KEYWORD' | 'FILE_PATH' | 'CHANGE_TYPE';
  pattern: string;                   // What triggered the flag
  severity: 'WARNING' | 'CRITICAL';
}
```

**Validation Rules**:
- `affected_files` paths must be relative to repository root (no leading `/`)
- `risk` must be `HIGH` if any `security_flags` have `severity: 'CRITICAL'`
- `auto_fix_decision` must be `HUMAN_REVIEW_REQUIRED` if `risk === 'HIGH'`
- `security_flags` array may be empty for non-security issues
- `reasoning` should be 1-3 sentences explaining classification logic

**Business Rules**:
- If `security_flags.length > 0`, then `auto_fix_decision = 'HUMAN_REVIEW_REQUIRED'`
- If `affected_files` includes `.env*`, `config/secrets/*`, then `risk = 'HIGH'`
- If `classification === 'DOCS'` and `affected_files` only include `*.md`, then `risk = 'LOW'`

**Relationships**:
- TriageResult → Issue (N:1) - References parent issue
- TriageResult → FixPlan (1:0..1) - If `auto_fix_decision === 'YES'`, may generate plan

---

### FixPlan

Implementation strategy generated by the planner agent.

**Source**: Planner Agent (LLM-generated implementation steps)

**Structure**:
```typescript
interface FixPlan {
  issue_number: number;              // Reference to source issue
  branch_name: string;               // Git branch (e.g., "fix/123-typo-readme")
  plan_steps: PlanStep[];            // Ordered implementation steps
  file_changes: FileChange[];        // Files to create/modify/delete
  validation_commands: string[];     // Commands to run (lint, build, etc.)
  human_check_reason: string | null; // Why human review needed (null if auto-fix)
  estimated_duration: number;        // Minutes (for human reference)
  timestamp: string;                 // ISO 8601 when plan generated
}

interface PlanStep {
  order: number;                     // Execution sequence (1-indexed)
  description: string;               // What to do (human-readable)
  command: string | null;            // Shell command (if applicable)
  files_involved: string[];          // Files this step touches
}

interface FileChange {
  path: string;                      // File path from repo root
  operation: 'CREATE' | 'MODIFY' | 'DELETE';
  change_summary: string;            // One-line description
  line_range: [number, number] | null; // Lines affected (null if CREATE/DELETE)
}
```

**Validation Rules**:
- `branch_name` must match pattern: `(fix|feature|docs)/<number>-<slug>` (slug: lowercase, hyphens, max 50 chars)
- `plan_steps` must be ordered sequentially (order: 1, 2, 3, ...)
- `validation_commands` must not include test commands (per Constitution Principle V)
- `file_changes` paths must not include security-sensitive patterns
- `estimated_duration` is informational only (not used for automation)

**Business Rules**:
- If `file_changes.length > 5`, then `human_check_reason` must explain why
- `validation_commands` should include: `npm run lint`, `npm run type-check`, `npm run build`
- `branch_name` slug derived from issue title (first 5 words, lowercase, hyphenated)

**Relationships**:
- FixPlan → TriageResult (N:1) - References parent triage result
- FixPlan → Commit[] (1:N) - Plan execution produces commits
- FixPlan → PullRequest (1:1) - Successful execution creates PR

---

### Commit

Atomic code change generated by the code agent.

**Source**: Code Agent (LLM-generated diffs applied via `git apply`)

**Structure**:
```typescript
interface Commit {
  issue_number: number;              // Reference to source issue
  message: string;                   // Git commit message
  diff: string;                      // Unified diff format
  files_changed: string[];           // Paths of modified files
  timestamp: string;                 // ISO 8601 when committed
  validation_results: ValidationResult[];
  sha: string;                       // Git commit SHA (after push)
}

interface ValidationResult {
  command: string;                   // Command executed (e.g., "npm run lint")
  exit_code: number;                 // 0 = success, non-zero = failure
  stdout: string;                    // Standard output (truncated to 1000 chars)
  stderr: string;                    // Standard error (truncated to 1000 chars)
  duration_ms: number;               // Execution time
}
```

**Validation Rules**:
- `message` must follow conventional commits format: `type(scope): description`
  - Valid types: `fix`, `feat`, `docs`, `chore`, `refactor`
  - Example: `fix(readme): correct typo in installation section`
- `diff` must be valid unified diff format (parsable by `git apply`)
- `files_changed` must match files in `diff`
- `validation_results` must all have `exit_code === 0` before PR creation
- `sha` is empty string until commit is pushed to remote

**Business Rules**:
- If any `validation_results[].exit_code !== 0`, rollback commit and abort
- Maximum `diff` size: 10,000 lines (larger changes require human review)
- Commit message `scope` should match affected module/component

**Relationships**:
- Commit → FixPlan (N:1) - Implements plan steps
- Commit → PullRequest (N:1) - Included in PR

---

### PullRequest

GitHub pull request generated by the PR generator agent.

**Source**: PR Generator Agent (formats data into GitHub PR)

**Structure**:
```typescript
interface PullRequest {
  number: number;                    // GitHub PR number (assigned after creation)
  issue_number: number;              // Reference to source issue
  title: string;                     // PR title (format: "Fix #123: <issue title>")
  body: string;                      // Markdown description (structured template)
  branch_name: string;               // Source branch (from FixPlan)
  base_branch: string;               // Target branch (usually "main")
  status: PRStatus;                  // Current state
  commits: string[];                 // Commit SHAs included in PR
  labels: string[];                  // Applied labels (e.g., ["auto-fix", "bug"])
  suggested_reviewers: string[];     // Usernames to request review from
  draft: boolean;                    // Draft mode for MEDIUM risk
  created_at: string;                // ISO 8601 timestamp
  url: string;                       // GitHub PR URL
}

type PRStatus = 'DRAFT' | 'OPEN' | 'APPROVED' | 'MERGED' | 'CLOSED';
```

**Validation Rules**:
- `title` must include issue reference: `Fix #<number>: <description>` or `Add #<number>: <description>`
- `body` must include required sections: Summary, What Changed, Why, Manual Verification, Risk Assessment
- `draft` must be `true` if source TriageResult has `risk === 'MEDIUM'`
- `suggested_reviewers` derived from CODEOWNERS or git blame (max 3 reviewers)
- `labels` must include `classification.toLowerCase()` from TriageResult (e.g., "bug")

**Body Template Structure**:
```markdown
## Summary
[One-sentence description from issue]

## What Changed
[Bullet list from FileChange.change_summary]

## Why
[Root cause from TriageResult.reasoning]

## Manual Verification
[Steps to verify the fix works]

## Risk Assessment
**Risk Level**: [TriageResult.risk]
**Affected Areas**: [TriageResult.affected_files]
**Rollback**: `git revert [commit SHA]`

<details>
<summary>Validation Results</summary>
[ValidationResult outputs formatted as code blocks]
</details>

## Suggested Reviewers
[suggested_reviewers as @mentions]
```

**Business Rules**:
- If `draft === true`, add comment: "This PR requires human review before merging (MEDIUM risk)."
- Link back to source issue in first line of body: "Fixes #<number>"
- Include all `commits` in PR (no squashing during auto-fix)

**Relationships**:
- PullRequest → Issue (N:1) - Fixes one issue
- PullRequest → TriageResult (N:1) - Based on triage analysis
- PullRequest → FixPlan (1:1) - Implements one plan
- PullRequest → Commit[] (1:N) - Contains multiple commits

---

### SecurityConstraint

Rule defining what changes are blocked from auto-fix.

**Source**: Configuration (hardcoded in triage agent)

**Structure**:
```typescript
interface SecurityConstraint {
  id: string;                        // Unique constraint identifier
  type: 'KEYWORD' | 'FILE_PATTERN' | 'CHANGE_TYPE';
  pattern: string;                   // Regex pattern or glob
  severity: 'WARNING' | 'CRITICAL';
  description: string;               // Human-readable explanation
  action: 'FLAG' | 'BLOCK';          // FLAG = add warning, BLOCK = prevent auto-fix
}
```

**Predefined Constraints**:
```typescript
const SECURITY_CONSTRAINTS: SecurityConstraint[] = [
  {
    id: 'secret-keyword',
    type: 'KEYWORD',
    pattern: '(password|secret|api.?key|token|credential|private.?key)',
    severity: 'CRITICAL',
    description: 'Issue mentions security-sensitive keywords',
    action: 'BLOCK'
  },
  {
    id: 'env-file',
    type: 'FILE_PATTERN',
    pattern: '**/.env*',
    severity: 'CRITICAL',
    description: 'Changes to environment files',
    action: 'BLOCK'
  },
  {
    id: 'secrets-dir',
    type: 'FILE_PATTERN',
    pattern: '**/config/secrets/**',
    severity: 'CRITICAL',
    description: 'Changes to secrets directory',
    action: 'BLOCK'
  },
  {
    id: 'deployment-config',
    type: 'FILE_PATTERN',
    pattern: '**/deployment/**',
    severity: 'CRITICAL',
    description: 'Changes to deployment configurations',
    action: 'BLOCK'
  },
  {
    id: 'database-migration',
    type: 'CHANGE_TYPE',
    pattern: 'migration|schema.change|alter.table',
    severity: 'CRITICAL',
    description: 'Database schema changes detected',
    action: 'BLOCK'
  },
  {
    id: 'auth-code',
    type: 'FILE_PATTERN',
    pattern: '**/*auth*/**',
    severity: 'WARNING',
    description: 'Changes to authentication code',
    action: 'FLAG'
  }
];
```

**Validation Rules**:
- `pattern` must be valid regex (for KEYWORD/CHANGE_TYPE) or glob (for FILE_PATTERN)
- `action === 'BLOCK'` must set `TriageResult.auto_fix_decision = 'HUMAN_REVIEW_REQUIRED'`
- `severity === 'CRITICAL'` implies `TriageResult.risk = 'HIGH'`

**Relationships**:
- SecurityConstraint → SecurityFlag (1:N) - Constraint violations create flags
- SecurityConstraint → TriageResult (used during triage evaluation)

---

## Data Flow

```
GitHub Issue (webhook)
  ↓
TriageResult (triage agent)
  ↓ (if auto_fix_decision === 'YES')
FixPlan (planner agent)
  ↓
Commit[] (code agent)
  ↓ (if validation passes)
PullRequest (PR generator)
```

## Persistence Strategy

**GitHub-native storage** (no external database):

1. **TriageResult**: Posted as JSON in issue comment with tag `<!-- TRIAGE_RESULT -->`
2. **FixPlan**: Posted as JSON in issue comment with tag `<!-- FIX_PLAN -->`
3. **ValidationResult[]**: Included in PR description within `<details>` block
4. **SecurityFlag[]**: Included in TriageResult comment (visible to maintainers)
5. **Audit log**: GitHub Actions logs (searchable via workflow run history)

**Benefits**:
- Zero external dependencies (aligns with Constitution Principle IV)
- Transparent (all data visible in GitHub UI)
- Auditable (immutable issue/PR timeline)
- Free (no database hosting costs)

**Retrieval**:
```typescript
// Parse JSON from issue comment
const triageResult = parseIssueCommentJSON(issue, '<!-- TRIAGE_RESULT -->');
```

## Type Safety

All TypeScript interfaces use `strict` mode (per Constitution):
- No `any` types (use `unknown` with type guards if needed)
- All optional fields explicitly marked with `?`
- Enums for fixed sets of values (IssueType, RiskLevel, etc.)
- Discriminated unions for sum types (AutoFixDecision)

## Serialization Format

All entities serialize to JSON for:
- GitHub API communication
- Issue comment storage
- PR description rendering
- Workflow artifact passing between jobs

**Example**:
```json
{
  "issue_number": 42,
  "classification": "BUG",
  "risk": "LOW",
  "affected_files": ["README.md"],
  "auto_fix_decision": "YES",
  "reasoning": "Simple documentation typo, low risk",
  "security_flags": [],
  "timestamp": "2025-12-02T10:30:00Z"
}
```

## Validation Summary

| Entity | Key Validations |
|--------|----------------|
| **Issue** | Non-empty title, valid timestamp, positive number |
| **TriageResult** | Security flags → HIGH risk, HIGH risk → human review required |
| **FixPlan** | Branch name pattern, no security-sensitive files, valid commands |
| **Commit** | Conventional commit format, unified diff format, validation passed |
| **PullRequest** | Issue reference in title, structured body, draft mode for MEDIUM risk |
| **SecurityConstraint** | Valid pattern, CRITICAL → BLOCK, WARNING → FLAG |

All validations enforced at construction time (fail-fast) or via TypeScript compiler.
