# PR Generator Agent Contract

**Agent**: PR Generator Agent  
**Purpose**: Create GitHub pull requests with comprehensive descriptions  
**Phase**: 4 - PR Creation

## Input

```typescript
interface PRGeneratorInput {
  issue: Issue;
  triage_result: TriageResult;
  fix_plan: FixPlan;
  commits: Commit[];
  repository_context: RepositoryContext;
}
```

**Example Input**:
```json
{
  "issue": {
    "number": 42,
    "title": "Fix typo in README",
    "body": "Line 15 has 'teh' instead of 'the'",
    "author": { "login": "johndoe" },
    "labels": ["docs", "auto-triage"]
  },
  "triage_result": {
    "classification": "DOCS",
    "risk": "LOW",
    "affected_files": ["README.md"],
    "reasoning": "Simple documentation typo, minimal risk"
  },
  "fix_plan": {
    "branch_name": "docs/42-fix-typo-readme",
    "file_changes": [
      {
        "path": "README.md",
        "operation": "MODIFY",
        "change_summary": "Correct typo: 'teh' ‚Üí 'the'"
      }
    ],
    "human_check_reason": null
  },
  "commits": [
    {
      "sha": "abc123def456",
      "message": "docs(readme): correct typo in installation section\n\nFixes #42",
      "files_changed": ["README.md"],
      "validation_results": [
        {
          "command": "npm run lint",
          "exit_code": 0,
          "stdout": "‚úì All files pass",
          "duration_ms": 1200
        }
      ]
    }
  ],
  "repository_context": {
    "codeowners": { "*.md": ["@docs-team"] },
    "default_branch": "main"
  }
}
```

## Output

```typescript
interface PRGeneratorOutput extends AgentResponse<PullRequest> {}
```

**Example Success Output**:
```json
{
  "success": true,
  "data": {
    "number": 123,
    "issue_number": 42,
    "title": "Fix #42: Fix typo in README",
    "body": "<!-- See template below -->",
    "branch_name": "docs/42-fix-typo-readme",
    "base_branch": "main",
    "status": "OPEN",
    "commits": ["abc123def456"],
    "labels": ["auto-fix", "docs", "low-risk"],
    "suggested_reviewers": ["docs-team"],
    "draft": false,
    "created_at": "2025-12-02T10:02:00Z",
    "url": "https://github.com/owner/repo/pull/123"
  }
}
```

## Processing Logic

### 1. Generate PR Title (FR-009)

```typescript
function generatePRTitle(issue: Issue, classification: IssueType): string {
  const prefix = classification === 'BUG' ? 'Fix' : 
                 classification === 'FEATURE' ? 'Add' :
                 classification === 'DOCS' ? 'Fix' :
                 'Update';
  
  // Capitalize first letter of issue title
  const titleCase = issue.title.charAt(0).toUpperCase() + issue.title.slice(1);
  
  return `${prefix} #${issue.number}: ${titleCase}`;
}
```

**Examples**:
- BUG: `Fix #42: Fix typo in README`
- FEATURE: `Add #100: Add dark mode support`
- DOCS: `Fix #50: Correct API documentation`
- CHORE: `Update #75: Update dependencies`

### 2. Generate PR Body (FR-009)

```typescript
function generatePRBody(input: PRGeneratorInput): string {
  const {
    issue,
    triage_result,
    fix_plan,
    commits
  } = input;
  
  return `
## Summary

Fixes #${issue.number}

${issue.title}

## What Changed

${fix_plan.file_changes.map(fc => `- \`${fc.path}\`: ${fc.change_summary}`).join('\n')}

## Why

**Root Cause**: ${triage_result.reasoning}

**Issue Description**: ${issue.body}

## Manual Verification

To verify this fix:

1. Check out this PR branch: \`git checkout ${fix_plan.branch_name}\`
2. Review the changes in: ${fix_plan.file_changes.map(fc => `\`${fc.path}\``).join(', ')}
3. ${generateVerificationSteps(triage_result.classification, fix_plan.file_changes)}

## Risk Assessment

**Risk Level**: ${triage_result.risk}  
**Affected Areas**: ${triage_result.affected_files.join(', ')}  
**Complexity**: ${fix_plan.estimated_complexity || 'Simple'}

### Rollback Instructions

If this PR causes issues after merging:

\`\`\`bash
git revert ${commits[0].sha}
\`\`\`

${triage_result.risk === 'MEDIUM' ? '‚ö†Ô∏è **MEDIUM RISK**: This PR requires maintainer review before merging.' : ''}

<details>
<summary>Validation Results</summary>

${commits.map(c => formatValidationResults(c.validation_results)).join('\n\n')}

</details>

<details>
<summary>Commits</summary>

${commits.map(c => `- ${c.sha.substring(0, 7)}: ${c.message.split('\n')[0]}`).join('\n')}

</details>

## Suggested Reviewers

${determineSuggestedReviewers(fix_plan.file_changes, input.repository_context.codeowners).map(r => `@${r}`).join(', ')}

---

*This PR was automatically generated by the GitHub Auto-Fix system.*
`;
}

function formatValidationResults(results: ValidationResult[]): string {
  return results.map(r => `
**Command**: \`${r.command}\`  
**Exit Code**: ${r.exit_code}  
**Duration**: ${r.duration_ms}ms

\`\`\`
${r.stdout}
\`\`\`

${r.stderr ? `**Errors**:\n\`\`\`\n${r.stderr}\n\`\`\`` : ''}
`).join('\n---\n');
}

function generateVerificationSteps(
  classification: IssueType,
  file_changes: FileChange[]
): string {
  switch (classification) {
    case 'DOCS':
      return `Open ${file_changes[0].path} and verify the content reads correctly`;
    case 'BUG':
      return `Test the scenario described in the issue to confirm the bug is fixed`;
    case 'FEATURE':
      return `Test the new functionality according to the issue requirements`;
    default:
      return `Verify the changes achieve the intended outcome`;
  }
}
```

### 3. Determine Suggested Reviewers (FR-020)

```typescript
function determineSuggestedReviewers(
  file_changes: FileChange[],
  codeowners: Record<string, string[]>
): string[] {
  const reviewers = new Set<string>();
  
  // Match files against CODEOWNERS patterns
  for (const change of file_changes) {
    for (const [pattern, owners] of Object.entries(codeowners)) {
      if (matchesPattern(change.path, pattern)) {
        owners.forEach(o => reviewers.add(o.replace('@', '')));
      }
    }
  }
  
  // If no CODEOWNERS matches, use git blame (last 3 committers)
  if (reviewers.size === 0) {
    const blamers = getRecentCommitters(file_changes.map(fc => fc.path), 3);
    blamers.forEach(b => reviewers.add(b));
  }
  
  // Limit to 3 reviewers
  return Array.from(reviewers).slice(0, 3);
}

function matchesPattern(path: string, pattern: string): boolean {
  // Convert CODEOWNERS glob pattern to regex
  const regex = new RegExp(
    pattern
      .replace(/\./g, '\\.')
      .replace(/\*/g, '.*')
      .replace(/\?/g, '.')
  );
  return regex.test(path);
}

async function getRecentCommitters(paths: string[], limit: number): Promise<string[]> {
  const committers = new Set<string>();
  
  for (const path of paths) {
    const result = await execShell(`git log -n ${limit} --format=%an -- ${path}`);
    result.stdout.split('\n').forEach(name => {
      if (name) committers.add(name);
    });
  }
  
  return Array.from(committers).slice(0, limit);
}
```

### 4. Select PR Labels (FR-006)

```typescript
function selectPRLabels(triage_result: TriageResult): string[] {
  const labels: string[] = ['auto-fix'];
  
  // Classification label
  labels.push(triage_result.classification.toLowerCase());
  
  // Risk label
  switch (triage_result.risk) {
    case 'LOW':
      labels.push('low-risk', 'good-first-issue');
      break;
    case 'MEDIUM':
      labels.push('medium-risk', 'needs-review');
      break;
    case 'HIGH':
      labels.push('high-risk', 'human-review-required');
      break;
  }
  
  // Security label if applicable
  if (triage_result.security_flags.length > 0) {
    labels.push('security');
  }
  
  return labels;
}
```

### 5. Create PR via GitHub API (FR-009)

```typescript
async function createPullRequest(
  title: string,
  body: string,
  branch_name: string,
  base_branch: string,
  draft: boolean
): Promise<number> {
  const response = await githubAPI.pulls.create({
    owner: repo.owner,
    repo: repo.name,
    title,
    body,
    head: branch_name,
    base: base_branch,
    draft, // true for MEDIUM risk
    maintainer_can_modify: true // Allow maintainers to push
  });
  
  return response.data.number;
}
```

### 6. Set Draft Mode (FR-010)

```typescript
function shouldBeDraft(triage_result: TriageResult, fix_plan: FixPlan): boolean {
  // MEDIUM risk issues require draft + human approval
  if (triage_result.risk === 'MEDIUM') return true;
  
  // Large scope changes require review
  if (fix_plan.file_changes.length > 5) return true;
  
  // Human check reason present
  if (fix_plan.human_check_reason) return true;
  
  return false;
}
```

### 7. Apply Labels and Request Reviewers

```typescript
async function applyLabelsAndReviewers(
  pr_number: number,
  labels: string[],
  reviewers: string[]
): Promise<void> {
  // Add labels
  await githubAPI.issues.addLabels({
    owner: repo.owner,
    repo: repo.name,
    issue_number: pr_number,
    labels
  });
  
  // Request reviewers (skip if draft)
  if (reviewers.length > 0) {
    await githubAPI.pulls.requestReviewers({
      owner: repo.owner,
      repo: repo.name,
      pull_number: pr_number,
      reviewers // GitHub usernames without @ prefix
    });
  }
}
```

### 8. Post Success Comment on Issue

```typescript
async function postSuccessComment(
  issue_number: number,
  pr_number: number,
  pr_url: string
): Promise<void> {
  const comment = `
‚úÖ **Automated fix complete!**

A pull request has been created: #${pr_number}

üîó [View PR](${pr_url})

The fix has been validated and is ready for review. If you approve the changes, a maintainer can merge the PR.
`;
  
  await githubAPI.issues.createComment({
    owner: repo.owner,
    repo: repo.name,
    issue_number,
    body: comment
  });
}
```

## Performance Requirements

- **Latency**: < 30 seconds
- **GitHub API calls**: 4-5 total
  - Create PR: 1 call
  - Add labels: 1 call
  - Request reviewers: 1 call
  - Post comment on issue: 1 call
  - (Optional) Get git blame: 1 call per file if no CODEOWNERS

## Side Effects

1. **Creates GitHub Pull Request** in repository
2. **Applies labels** to PR
3. **Requests reviewers** (if not draft)
4. **Posts comment** on source issue linking to PR
5. **Links PR to issue** (via "Fixes #<number>" in body)

## Error Scenarios

| Scenario | Error Code | Action |
|----------|-----------|--------|
| PR creation fails (API error) | `PR_CREATION_FAILED` | Retry once, then abort and comment on issue |
| Branch doesn't exist | `BRANCH_NOT_FOUND` | Error (should be created by Code Agent) |
| Duplicate PR exists | `DUPLICATE_PR` | Skip creation, update existing PR body |
| Label doesn't exist in repo | `LABEL_NOT_FOUND` | Skip that label, continue with others |
| Reviewer not a collaborator | `INVALID_REVIEWER` | Skip that reviewer, continue with others |
| Rate limit exceeded | `RATE_LIMIT_EXCEEDED` | Wait and retry with exponential backoff |

## Validation Rules

- `title` must match: `^(Fix|Add|Update) #\d+: .{10,100}$`
- `body` must include section headers: Summary, What Changed, Why, Manual Verification, Risk Assessment
- `body` must include issue reference: `Fixes #<number>` in first paragraph
- `labels` must include `auto-fix` and `classification.toLowerCase()`
- `draft === true` if `triage_result.risk === 'MEDIUM'`
- `commits` array must not be empty
- `base_branch` must match repository's `default_branch`

## PR Body Template Structure

```markdown
## Summary
[One-sentence + issue link]

## What Changed
[Bullet list of file changes]

## Why
[Root cause explanation]

## Manual Verification
[Step-by-step verification instructions]

## Risk Assessment
**Risk Level**: [LOW/MEDIUM/HIGH]
**Affected Areas**: [file list]
**Complexity**: [TRIVIAL/SIMPLE/MODERATE/COMPLEX]

### Rollback Instructions
[git revert command]

<details>
<summary>Validation Results</summary>
[Collapsible validation outputs]
</details>

<details>
<summary>Commits</summary>
[Commit list with SHAs]
</details>

## Suggested Reviewers
[@user1, @user2]

---
*Auto-generated disclaimer*
```

## Testing Approach

**Manual Verification Steps**:

1. **LOW Risk PR**:
   - Run PR generator with docs fix input
   - Verify: PR created with title `Fix #42: Fix typo in README`
   - Verify: PR body includes all required sections
   - Verify: PR is NOT in draft mode
   - Verify: Labels applied: `auto-fix`, `docs`, `low-risk`
   - Verify: Comment posted on issue #42 with PR link

2. **MEDIUM Risk PR**:
   - Run PR generator with multi-file change input
   - Verify: PR created in DRAFT mode
   - Verify: Labels include `needs-review`, `medium-risk`
   - Verify: Warning message in body about human review
   - Verify: Reviewers requested based on CODEOWNERS

3. **Validation Results Display**:
   - Verify: Collapsible `<details>` section contains validation outputs
   - Verify: Each command shows exit code, duration, stdout/stderr
   - Verify: Stdout/stderr truncated to 1000 chars if longer

## Integration Points

- **Input Source**: Code Agent output (commits) + previous agent artifacts
- **Output Destination**: GitHub repository (creates PR)
- **Side Effects**: GitHub PR, labels, comments, reviewer requests
- **Final Step**: End of auto-fix pipeline

## GitHub API Permissions Required

```yaml
permissions:
  contents: write        # Create branches, commit
  pull-requests: write   # Create PRs, request reviews
  issues: write          # Add labels, post comments
```

## Idempotency

Check if PR already exists for the branch:
```typescript
async function findExistingPR(branch_name: string): Promise<number | null> {
  const response = await githubAPI.pulls.list({
    owner: repo.owner,
    repo: repo.name,
    head: `${repo.owner}:${branch_name}`,
    state: 'open'
  });
  
  return response.data.length > 0 ? response.data[0].number : null;
}
```

If PR exists:
- Update PR body instead of creating new
- Ensure labels are current
- Re-request reviewers if needed

## Success Metrics Alignment

- **SC-004**: Auto-generated PRs include comprehensive descriptions with all required sections (summary, changes, tests, risks) in 100% of cases
  - ‚úÖ Template includes all sections
  - ‚úÖ Validation results included in collapsible details
  - ‚úÖ Rollback instructions provided

- **FR-009**: System MUST generate comprehensive PR descriptions including: summary, file changes, root cause, test results, risk assessment, and rollback instructions
  - ‚úÖ All required elements present in template
  - ‚úÖ Structured markdown with clear sections
  - ‚úÖ Collapsible details for verbose output
